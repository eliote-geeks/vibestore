name: ğŸš€ Deploy VibeStore237

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    name: ğŸ§ª Tests & Quality
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: vibestore_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, pgsql, pdo_pgsql, bcmath, soap, intl, gd, exif, iconv
          coverage: none

      - name: ğŸ“¥ Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: ğŸ“¥ Cache NPM dependencies
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-npm-

      - name: ğŸ› ï¸ Install Composer dependencies
        run: composer install --no-progress --prefer-dist --optimize-autoloader

      - name: ğŸ› ï¸ Install NPM dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build assets
        run: npm run build

      - name: ğŸ“‹ Copy environment file
        run: cp .env.example .env

      - name: ğŸ”‘ Generate app key
        run: php artisan key:generate

      - name: ğŸ—„ï¸ Run database migrations
        run: php artisan migrate --force
        env:
          DB_CONNECTION: pgsql
          DB_HOST: localhost
          DB_PORT: 5432
          DB_DATABASE: vibestore_test
          DB_USERNAME: postgres
          DB_PASSWORD: postgres

      - name: ğŸ§ª Run PHP tests
        run: php artisan test
        env:
          DB_CONNECTION: pgsql
          DB_HOST: localhost
          DB_PORT: 5432
          DB_DATABASE: vibestore_test
          DB_USERNAME: postgres
          DB_PASSWORD: postgres

      - name: ğŸ“Š PHP Code Quality (Laravel Pint)
        run: ./vendor/bin/pint --test

  deploy:
    name: ğŸš€ Deploy to VPS
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: ğŸŒ Deploy to VPS
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} '
            set -e
            
            echo "ğŸš€ DÃ©but du dÃ©ploiement..."
            
            # Variables
            APP_DIR="/var/www/vibestore"
            BACKUP_DIR="/var/backups/vibestore/$(date +%Y%m%d_%H%M%S)"
            
            # CrÃ©er un backup de l'\''application actuelle
            if [ -d "$APP_DIR" ]; then
              echo "ğŸ’¾ CrÃ©ation du backup..."
              sudo mkdir -p "$BACKUP_DIR"
              sudo cp -r "$APP_DIR" "$BACKUP_DIR/"
              echo "âœ… Backup crÃ©Ã©: $BACKUP_DIR"
            fi
            
            # Mettre l'\''application en mode maintenance
            if [ -f "$APP_DIR/artisan" ]; then
              echo "ğŸš§ Activation du mode maintenance..."
              cd "$APP_DIR"
              sudo -u www-data php artisan down --retry=60 --secret="$(openssl rand -base64 32)"
            fi
            
            # CrÃ©er le rÃ©pertoire s'\''il n'\''existe pas
            if [ ! -d "$APP_DIR" ]; then
              sudo mkdir -p "$APP_DIR"
              sudo chown www-data:www-data "$APP_DIR"
            fi
            
            # Aller dans le rÃ©pertoire de l'\''application
            cd "$APP_DIR"
            
            # Mettre Ã  jour le code depuis GitHub
            echo "ğŸ“¥ Mise Ã  jour du code..."
            if [ -d ".git" ]; then
              sudo -u www-data git fetch origin
              sudo -u www-data git reset --hard origin/main
            else
              sudo -u www-data git clone https://github.com/${{ github.repository }}.git .
            fi
            
            # Installer/mettre Ã  jour les dÃ©pendances Composer
            echo "ğŸ“¦ Installation des dÃ©pendances PHP..."
            sudo -u www-data composer install --no-dev --optimize-autoloader --no-interaction
            
            # Installer/mettre Ã  jour les dÃ©pendances NPM et build
            echo "ğŸ› ï¸ Build des assets..."
            sudo -u www-data npm ci --only=production
            sudo -u www-data npm run build
            
            # Copier le fichier .env s'\''il n'\''existe pas
            if [ ! -f ".env" ]; then
              echo "âš™ï¸ Configuration de l'\''environnement..."
              sudo -u www-data cp .env.example .env
              sudo -u www-data php artisan key:generate
            fi
            
            # Permissions
            echo "ğŸ” Configuration des permissions..."
            sudo chown -R www-data:www-data "$APP_DIR"
            sudo chmod -R 755 "$APP_DIR"
            sudo chmod -R 775 "$APP_DIR/storage"
            sudo chmod -R 775 "$APP_DIR/bootstrap/cache"
            
            # Migrations et optimisations
            echo "ğŸ—„ï¸ Migrations de base de donnÃ©es..."
            sudo -u www-data php artisan migrate --force
            
            echo "âš¡ Optimisation Laravel..."
            sudo -u www-data php artisan config:cache
            sudo -u www-data php artisan route:cache
            sudo -u www-data php artisan view:cache
            sudo -u www-data php artisan event:cache
            
            # RedÃ©marrer les services
            echo "ğŸ”„ RedÃ©marrage des services..."
            sudo systemctl restart php8.2-fpm
            sudo systemctl restart nginx
            
            # RedÃ©marrer le worker si il existe
            if systemctl is-active --quiet vibestore-worker; then
              sudo systemctl restart vibestore-worker
            fi
            
            # RedÃ©marrer websocket si il existe
            if systemctl is-active --quiet vibestore-websocket; then
              sudo systemctl restart vibestore-websocket
            fi
            
            # Sortir du mode maintenance
            echo "âœ… DÃ©sactivation du mode maintenance..."
            sudo -u www-data php artisan up
            
            # Nettoyer les anciens backups (garder les 5 derniers)
            echo "ğŸ§¹ Nettoyage des anciens backups..."
            sudo find /var/backups/vibestore/ -maxdepth 1 -type d -mtime +5 -exec rm -rf {} + 2>/dev/null || true
            
            echo "ğŸ‰ DÃ©ploiement terminÃ© avec succÃ¨s!"
            echo "ğŸŒ Application disponible sur: https://${{ secrets.VPS_DOMAIN }}"
          '

      - name: ğŸ” Health Check
        run: |
          sleep 30
          response=$(curl -s -o /dev/null -w "%{http_code}" https://${{ secrets.VPS_DOMAIN }})
          if [ $response -eq 200 ]; then
            echo "âœ… Health check passed: $response"
          else
            echo "âŒ Health check failed: $response"
            exit 1
          fi

      - name: ğŸ“± Notify Discord/Slack (Optional)
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… DÃ©ploiement rÃ©ussi - VibeStore237 mis Ã  jour!"
          else
            echo "âŒ Ã‰chec du dÃ©ploiement - VÃ©rification nÃ©cessaire"
          fi
          # Ajouter ici votre webhook Discord/Slack si nÃ©cessaire

  rollback:
    name: ğŸ”„ Rollback
    runs-on: ubuntu-latest
    if: failure() && github.ref == 'refs/heads/main'
    needs: deploy
    
    steps:
      - name: ğŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: ğŸ”„ Rollback to previous version
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} '
            echo "ğŸ”„ Rollback en cours..."
            
            APP_DIR="/var/www/vibestore"
            LATEST_BACKUP=$(ls -td /var/backups/vibestore/*/ | head -1)
            
            if [ -n "$LATEST_BACKUP" ]; then
              echo "ğŸ“¦ Restauration depuis: $LATEST_BACKUP"
              sudo rm -rf "$APP_DIR"
              sudo cp -r "$LATEST_BACKUP/vibestore237" "/var/www/"
              sudo chown -R www-data:www-data "$APP_DIR"
              sudo systemctl restart php8.2-fpm nginx
              sudo -u www-data php artisan up
              echo "âœ… Rollback terminÃ©"
            else
              echo "âŒ Aucun backup trouvÃ© pour le rollback"
              exit 1
            fi
          '