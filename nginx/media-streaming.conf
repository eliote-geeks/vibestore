# Configuration avancée pour le streaming média VibeStore237
# Optimisations spéciales pour audio/vidéo

# Configuration du streaming audio adaptatif
location /stream/audio/ {
    # Rate limiting pour le streaming
    limit_req zone=media burst=10 nodelay;
    
    # Headers pour le streaming audio
    add_header Accept-Ranges bytes;
    add_header Content-Type audio/mpeg;
    add_header Cache-Control "private, no-transform";
    add_header X-Content-Type-Options nosniff;
    
    # Support du HTTP Range pour le streaming progressif
    if ($http_range) {
        add_header Content-Range $sent_http_content_range;
    }
    
    # Protection anti-hotlinking avancée
    valid_referers none blocked server_names
        *.vibestore237.com
        vibestore237.com
        localhost
        127.0.0.1;
    
    if ($invalid_referer) {
        return 403 "Accès interdit - Hotlinking détecté";
    }
    
    # Vérification de l'authentification pour les contenus premium
    auth_request /auth-check;
    auth_request_set $auth_user $upstream_http_x_user;
    auth_request_set $auth_subscription $upstream_http_x_subscription;
    
    # Headers d'authentification
    proxy_set_header X-User $auth_user;
    proxy_set_header X-Subscription $auth_subscription;
    
    # Gestion des erreurs d'authentification
    error_page 401 403 = @auth_error;
    
    # Servir le fichier audio
    alias /var/www/vibestore237/storage/app/private/audio/;
    
    # Optimisations pour le streaming
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    
    # Log spécialisé pour le streaming audio
    access_log /var/log/nginx/vibestore237_audio_stream.log combined;
}

# Configuration du streaming vidéo adaptatif
location /stream/video/ {
    # Rate limiting plus strict pour la vidéo
    limit_req zone=media burst=5 nodelay;
    
    # Headers pour le streaming vidéo
    add_header Accept-Ranges bytes;
    add_header Content-Type video/mp4;
    add_header Cache-Control "private, no-transform";
    add_header X-Content-Type-Options nosniff;
    
    # Support du HTTP Range pour le streaming progressif
    if ($http_range) {
        add_header Content-Range $sent_http_content_range;
    }
    
    # Protection anti-hotlinking
    valid_referers none blocked server_names
        *.vibestore237.com
        vibestore237.com;
    
    if ($invalid_referer) {
        return 403;
    }
    
    # Vérification de l'authentification
    auth_request /auth-check;
    
    # Gestion des erreurs
    error_page 401 403 = @auth_error;
    
    # Servir le fichier vidéo
    alias /var/www/vibestore237/storage/app/private/video/;
    
    # Optimisations pour le streaming vidéo
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    
    # Log spécialisé pour le streaming vidéo
    access_log /var/log/nginx/vibestore237_video_stream.log combined;
}

# Point d'authentification interne
location = /auth-check {
    internal;
    proxy_pass http://127.0.0.1/api/media/auth-check;
    proxy_pass_request_body off;
    proxy_set_header Content-Length "";
    proxy_set_header X-Original-URI $request_uri;
    proxy_set_header X-Original-Method $request_method;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# Gestion des erreurs d'authentification
location @auth_error {
    add_header Content-Type application/json always;
    return 401 '{"error":"Authentification requise","message":"Vous devez être connecté pour accéder à ce contenu"}';
}

# Configuration pour les previews audio (30 secondes)
location /preview/audio/ {
    # Rate limiting plus permissif pour les previews
    limit_req zone=media burst=20 nodelay;
    
    # Headers pour les previews
    add_header Accept-Ranges bytes;
    add_header Content-Type audio/mpeg;
    add_header Cache-Control "public, max-age=3600";
    add_header X-Content-Type-Options nosniff;
    
    # Pas d'authentification pour les previews
    alias /var/www/vibestore237/storage/app/public/previews/;
    
    # Log pour les previews
    access_log /var/log/nginx/vibestore237_preview.log combined;
}

# Configuration pour les miniatures vidéo
location /thumbnails/ {
    # Cache long pour les miniatures
    expires 7d;
    add_header Cache-Control "public, immutable";
    add_header Vary "Accept-Encoding";
    
    # Compression automatique des images
    location ~* \.(jpg|jpeg|png|webp)$ {
        # Si le module image_filter est disponible
        # image_filter resize 300 200;
        # image_filter_jpeg_quality 80;
        # image_filter_webp_quality 80;
    }
    
    alias /var/www/vibestore237/storage/app/public/thumbnails/;
}

# Configuration pour le download sécurisé
location /download/ {
    # Rate limiting strict pour les téléchargements
    limit_req zone=media burst=3 nodelay;
    
    # Authentification obligatoire
    auth_request /auth-check;
    auth_request_set $auth_user $upstream_http_x_user;
    auth_request_set $download_allowed $upstream_http_x_download_allowed;
    
    # Vérifier si le téléchargement est autorisé
    if ($download_allowed != "true") {
        return 403 "Téléchargement non autorisé";
    }
    
    # Headers pour forcer le téléchargement
    add_header Content-Disposition "attachment";
    add_header Content-Type application/octet-stream;
    add_header X-Content-Type-Options nosniff;
    add_header X-Robots-Tag "noindex, nofollow";
    
    # Protection contre les bots
    if ($http_user_agent ~* "bot|crawler|spider|scraper") {
        return 403;
    }
    
    # Servir le fichier protégé
    alias /var/www/vibestore237/storage/app/private/downloads/;
    
    # Log des téléchargements
    access_log /var/log/nginx/vibestore237_downloads.log combined;
}

# Configuration pour l'upload de fichiers média
location /upload/media {
    # Rate limiting pour les uploads
    limit_req zone=api burst=5 nodelay;
    
    # Taille maximum pour les uploads média
    client_max_body_size 500M;
    client_body_timeout 600s;
    
    # Authentification obligatoire
    auth_request /auth-check;
    
    # Proxy vers Laravel pour traitement
    try_files $uri $uri/ /index.php?$query_string;
    
    # Log des uploads
    access_log /var/log/nginx/vibestore237_uploads.log combined;
}

# Configuration pour la compression audio à la volée (optionnel)
location /compress/audio/ {
    # Rate limiting
    limit_req zone=media burst=5 nodelay;
    
    # Headers
    add_header Content-Type audio/mpeg;
    add_header Cache-Control "private, max-age=3600";
    
    # Authentification
    auth_request /auth-check;
    
    # Compression via FFmpeg (nécessite configuration additionnelle)
    # proxy_pass http://127.0.0.1:8081/compress/;
    
    # Pour l'instant, servir directement
    alias /var/www/vibestore237/storage/app/private/audio/;
}

# Configuration pour les playlists HLS (streaming adaptatif)
location /hls/ {
    # Headers pour HLS
    add_header Access-Control-Allow-Origin "*";
    add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
    add_header Access-Control-Allow-Headers "Range";
    
    # Cache pour les segments HLS
    location ~* \.m3u8$ {
        expires 5s;
        add_header Cache-Control "no-cache, private";
    }
    
    location ~* \.ts$ {
        expires 1h;
        add_header Cache-Control "public, immutable";
    }
    
    # Authentification pour HLS
    auth_request /auth-check;
    
    # Servir les fichiers HLS
    alias /var/www/vibestore237/storage/app/private/hls/;
    
    # Optimisations
    sendfile on;
    tcp_nopush on;
    
    # Log HLS
    access_log /var/log/nginx/vibestore237_hls.log combined;
}

# Configuration pour les WebRTC (streaming temps réel)
location /webrtc/ {
    # Proxy vers le serveur WebRTC
    proxy_pass http://127.0.0.1:8082;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Timeout pour WebRTC
    proxy_read_timeout 86400;
    proxy_send_timeout 86400;
}

# Configuration pour les statistiques de streaming
location /stats/streaming {
    # Authentification admin
    auth_request /admin-auth-check;
    
    # Retourner les statistiques
    content_by_lua_block {
        -- Nécessite lua-resty-core
        local json = require "cjson"
        local stats = {
            active_streams = ngx.shared.streams:get("active_count") or 0,
            total_bandwidth = ngx.shared.streams:get("bandwidth") or 0,
            concurrent_users = ngx.shared.streams:get("users") or 0
        }
        ngx.header.content_type = "application/json"
        ngx.say(json.encode(stats))
    }
}

# Point d'authentification admin
location = /admin-auth-check {
    internal;
    proxy_pass http://127.0.0.1/api/admin/auth-check;
    proxy_pass_request_body off;
    proxy_set_header Content-Length "";
    proxy_set_header X-Original-URI $request_uri;
}