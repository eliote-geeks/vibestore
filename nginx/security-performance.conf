# Configuration de sécurité et performance avancée pour VibeStore237
# Optimisations spécialisées pour une plateforme musicale

# ===========================================
# OPTIMISATIONS DE PERFORMANCE
# ===========================================

# Configuration du cache Nginx
proxy_cache_path /var/cache/nginx/vibestore_api levels=1:2 keys_zone=api_cache:100m max_size=1g inactive=60m use_temp_path=off;
proxy_cache_path /var/cache/nginx/vibestore_static levels=1:2 keys_zone=static_cache:100m max_size=2g inactive=7d use_temp_path=off;
proxy_cache_path /var/cache/nginx/vibestore_thumbnails levels=1:2 keys_zone=thumb_cache:50m max_size=500m inactive=30d use_temp_path=off;

# Cache des microdonnées FastCGI
fastcgi_cache_path /var/cache/nginx/vibestore_fcgi levels=1:2 keys_zone=fcgi_cache:100m max_size=1g inactive=60m use_temp_path=off;

# Configuration des buffers optimisés
client_body_buffer_size 128k;
client_header_buffer_size 1k;
large_client_header_buffers 4 4k;
output_buffers 1 32k;
postpone_output 1460;

# Configuration des timeouts optimisés
client_body_timeout 60s;
client_header_timeout 60s;
keepalive_timeout 65s;
send_timeout 60s;

# Optimisations TCP
tcp_nopush on;
tcp_nodelay on;
sendfile on;
sendfile_max_chunk 1m;

# Configuration des workers
worker_processes auto;
worker_rlimit_nofile 65535;
worker_connections 4096;

# ===========================================
# CONFIGURATION DE SÉCURITÉ AVANCÉE
# ===========================================

# Protection DDoS avec rate limiting avancé
limit_req_zone $binary_remote_addr zone=ddos_protection:50m rate=100r/m;
limit_req_zone $binary_remote_addr zone=login_protection:10m rate=3r/m;
limit_req_zone $binary_remote_addr zone=api_protection:20m rate=60r/m;
limit_req_zone $binary_remote_addr zone=search_protection:10m rate=30r/m;
limit_req_zone $binary_remote_addr zone=download_protection:10m rate=10r/m;

# Protection contre les connexions simultanées
limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;
limit_conn_zone $server_name zone=conn_limit_per_server:10m;

# Géolocalisation pour bloquer certains pays (optionnel)
# geoip2 /usr/share/GeoIP/GeoLite2-Country.mmdb {
#     auto_reload 5m;
#     $geoip2_metadata_country_build metadata build_epoch;
#     $geoip2_data_country_code default=US source=$remote_addr country iso_code;
#     $geoip2_data_country_name country names en;
# }

# Map pour détecter les bots malveillants
map $http_user_agent $bad_bot {
    default 0;
    ~*^$ 1;  # User agent vide
    ~*(bot|crawler|spider|scraper|wget|curl) 1;
    ~*(scan|hack|exploit|attack) 1;
    ~*(sqlmap|nmap|nikto|dirbuster) 1;
}

# Map pour détecter les referrers suspects
map $http_referer $bad_referer {
    default 0;
    ~*(baidu|yandex|spam|adult|casino|pharma) 1;
    ~*(bit\.ly|tinyurl|shortener) 1;
}

# Headers de sécurité avancés
map $sent_http_content_type $security_headers {
    default "max-age=31536000; includeSubDomains; preload";
    ~image/ "max-age=31536000; includeSubDomains";
    ~audio/ "max-age=31536000; includeSubDomains";
    ~video/ "max-age=31536000; includeSubDomains";
}

# ===========================================
# CONFIGURATION SSL/TLS AVANCÉE
# ===========================================

# Configuration SSL optimisée pour la performance
ssl_protocols TLSv1.2 TLSv1.3;
ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
ssl_prefer_server_ciphers off;

# Session SSL optimisée
ssl_session_cache shared:SSL:100m;
ssl_session_timeout 24h;
ssl_session_tickets off;

# OCSP Stapling
ssl_stapling on;
ssl_stapling_verify on;
ssl_trusted_certificate /etc/letsencrypt/live/vibestore237.com/chain.pem;
resolver 8.8.8.8 8.8.4.4 valid=300s;
resolver_timeout 5s;

# ===========================================
# PROTECTION CONTRE LES ATTAQUES
# ===========================================

# Protection XSS et injection
map $args $suspicious_args {
    default 0;
    ~*(<script|javascript:|on\w+\s*=) 1;
    ~*(union|select|insert|delete|drop|update|exec) 1;
    ~*(\.\./|\.\.\\|/etc/passwd|/proc/) 1;
    ~*(base64_decode|eval|system|shell_exec) 1;
}

# Protection contre les requêtes malformées
map $request_method $suspicious_method {
    default 0;
    ~*^(TRACE|TRACK|DEBUG|OPTIONS)$ 1;
}

# Protection contre les user agents suspects
map $http_user_agent $suspicious_ua {
    default 0;
    ~*^-?$ 1;
    ~*(libwww|lwp-trivial|curl|wget|python-urllib|python-requests) 1;
    ~*(scanner|checker|monitoring|test) 1;
}

# ===========================================
# CONFIGURATION PAR ZONES
# ===========================================

# Zone d'administration ultra-sécurisée
location /admin {
    # Limitation stricte des connexions
    limit_conn conn_limit_per_ip 5;
    limit_req zone=login_protection burst=2 nodelay;
    
    # Blocage des bots
    if ($bad_bot) {
        return 403 "Bot non autorisé";
    }
    
    # Protection géographique (décommenter si nécessaire)
    # if ($geoip2_data_country_code !~ ^(FR|CM|CA|BE|CH)$) {
    #     return 403 "Accès géographiquement restreint";
    # }
    
    # Headers de sécurité renforcés
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self'; media-src 'self';" always;
    
    # Authentication HTTP additionnelle (décommenter si nécessaire)
    # auth_basic "Zone Administration VibeStore237";
    # auth_basic_user_file /etc/nginx/.htpasswd_admin;
    
    try_files $uri $uri/ /index.php?$query_string;
}

# Zone API avec protection avancée
location /api {
    # Rate limiting API
    limit_req zone=api_protection burst=20 nodelay;
    limit_conn conn_limit_per_ip 10;
    
    # Blocage des attaques
    if ($bad_bot) {
        return 429 "Rate limit exceeded";
    }
    
    if ($suspicious_args) {
        return 400 "Requête suspecte détectée";
    }
    
    # Headers CORS sécurisés
    add_header Access-Control-Allow-Origin "https://vibestore237.com" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Accept, Authorization, Content-Type, X-Requested-With" always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Max-Age "86400" always;
    
    # Cache API intelligent
    location ~* ^/api/(sounds|artists|categories|events)/?$ {
        # Cache pour les endpoints de lecture
        proxy_cache api_cache;
        proxy_cache_valid 200 302 5m;
        proxy_cache_valid 404 1m;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_background_update on;
        add_header X-Cache-Status $upstream_cache_status;
    }
    
    try_files $uri $uri/ /index.php?$query_string;
}

# Zone de recherche avec protection
location /search {
    limit_req zone=search_protection burst=10 nodelay;
    
    # Protection contre les requêtes de recherche malveillantes
    if ($args ~* "(\<|%3C).*script.*(\>|%3E)") {
        return 403;
    }
    
    if ($args ~* "(union|select|insert|delete|drop|update|exec)") {
        return 403;
    }
    
    # Cache des résultats de recherche
    proxy_cache api_cache;
    proxy_cache_valid 200 10m;
    proxy_cache_key "$scheme$request_method$host$request_uri$args";
    add_header X-Cache-Status $upstream_cache_status;
    
    try_files $uri $uri/ /index.php?$query_string;
}

# Zone de téléchargement avec protection DRM
location /download {
    limit_req zone=download_protection burst=3 nodelay;
    limit_conn conn_limit_per_ip 2;
    
    # Authentification obligatoire
    auth_request /auth-download;
    auth_request_set $download_token $upstream_http_x_download_token;
    auth_request_set $user_subscription $upstream_http_x_user_subscription;
    
    # Vérification du token de téléchargement
    if ($download_token = "") {
        return 403 "Token de téléchargement manquant";
    }
    
    # Headers anti-piratage
    add_header X-Robots-Tag "noindex, nofollow, nosnippet, noarchive" always;
    add_header Content-Disposition "attachment" always;
    add_header X-Download-Token $download_token always;
    
    # Watermarking (nécessite module externe)
    # add_header X-Watermark "VibeStore237-$user_subscription-$download_token";
    
    # Logging avancé pour audit
    access_log /var/log/nginx/vibestore237_downloads_audit.log combined;
    
    try_files $uri $uri/ /index.php?$query_string;
}

# ===========================================
# OPTIMISATIONS SPÉCIFIQUES POUR LE MÉDIA
# ===========================================

# Cache intelligent pour les thumbnails
location ~* ^/thumbnails/.*\.(jpg|jpeg|png|webp)$ {
    expires 30d;
    add_header Cache-Control "public, immutable";
    add_header Vary "Accept-Encoding";
    
    # Cache proxy pour les thumbnails
    proxy_cache thumb_cache;
    proxy_cache_valid 200 30d;
    proxy_cache_use_stale error timeout updating;
    
    # Optimisation des images à la volée (si module disponible)
    # image_filter resize 300 300;
    # image_filter_jpeg_quality 85;
    # image_filter_webp_quality 85;
    
    try_files $uri =404;
}

# Optimisation pour les waveforms et spectrogrammes
location ~* ^/waveforms/.*\.(svg|png|json)$ {
    expires 7d;
    add_header Cache-Control "public, immutable";
    
    # Compression spéciale pour SVG
    location ~* \.svg$ {
        gzip_static on;
        add_header Content-Encoding gzip;
    }
    
    try_files $uri =404;
}

# ===========================================
# MONITORING ET LOGGING AVANCÉ
# ===========================================

# Format de log personnalisé pour VibeStore237
log_format vibestore_extended '$remote_addr - $remote_user [$time_local] '
                              '"$request" $status $bytes_sent '
                              '"$http_referer" "$http_user_agent" '
                              '$request_time $upstream_response_time '
                              '$geoip2_data_country_code $ssl_protocol $ssl_cipher '
                              '$http_x_forwarded_for "$http_authorization"';

# Log des erreurs de sécurité
error_log /var/log/nginx/vibestore237_security.log warn;

# Log des accès suspects
map $status $suspicious_status {
    ~^4 1;
    default 0;
}

# ===========================================
# CONFIGURATION D'URGENCE
# ===========================================

# Mode maintenance avec bypass pour admin
set $maintenance_mode off;

# Fichier de maintenance
if (-f /var/www/vibestore237/maintenance.html) {
    set $maintenance_mode on;
}

# Bypass pour les admins (par IP)
if ($remote_addr ~ ^(192\.168\.1\.|10\.0\.0\.|127\.0\.0\.1)) {
    set $maintenance_mode off;
}

# Redirection vers la page de maintenance
if ($maintenance_mode = on) {
    return 503;
}

# Page de maintenance personnalisée
error_page 503 @maintenance;
location @maintenance {
    root /var/www/vibestore237/public;
    try_files /maintenance.html =503;
    add_header Retry-After 3600 always;
    add_header Content-Type text/html always;
}

# ===========================================
# HEADERS DE PERFORMANCE
# ===========================================

# Préchargement DNS
add_header Link "</api/sounds>; rel=dns-prefetch" always;
add_header Link "<https://fonts.googleapis.com>; rel=dns-prefetch" always;

# Early hints pour les ressources critiques
add_header Link "</css/app.css>; rel=preload; as=style" always;
add_header Link "</js/app.js>; rel=preload; as=script" always;

# Service Worker pour le cache offline
location /sw.js {
    expires 0;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Service-Worker-Allowed "/";
}

# Manifest pour PWA
location /manifest.json {
    expires 1d;
    add_header Cache-Control "public";
    add_header Content-Type application/json;
}